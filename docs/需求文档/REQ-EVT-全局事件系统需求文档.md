# 全局事件系统需求文档 (EVT)

## 文档信息
- 文档编号：REQ-EVT-v1.0
- 创建日期：2025-07-22
- 作者：系统分析师
- 状态：草案

## 1. 概述

### 1.1 目的
本文档定义了TrueSinging游戏中全局事件系统的功能需求，包括6种特殊事件的触发、效果和玩家交互机制。

### 1.2 范围
全局事件系统涵盖游戏中所有特殊事件的管理，包括金币冲刺、火爆促销、闪电风暴、太阳耀斑、冰冻风暴和故障事件。

### 1.3 相关文档
- 代码结构整合文档.md
- src/ReplicatedStorage/Library/Configs/Global Events.lua
- src/ReplicatedStorage/Library/Configs/Mutations.lua
- src/ReplicatedStorage/Library/Configs/Eggs.lua

## 2. 功能需求

### 2.1 泛在型需求 (Ubiquitous Requirements)

#### REQ-EVT-001
- **需求编号**：REQ-EVT-001
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应提供6种全局事件：Gold Rush（金币冲刺）、Fire Sale（火爆促销）、Lightning Storm（闪电风暴）、Solar Flare（太阳耀斑）、Icey Storm（冰冻风暴）、Glitch Event（故障事件）。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 系统支持6种不同的全局事件
  - 每种事件有唯一的标识符
  - 事件可以独立触发和结束

#### REQ-EVT-002
- **需求编号**：REQ-EVT-002
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应为每个事件定义持续时间、触发条件和效果参数。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 每个事件有明确的持续时间
  - 触发条件可配置
  - 效果参数清晰定义

#### REQ-EVT-003
- **需求编号**：REQ-EVT-003
- **需求类型**：泛在型
- **优先级**：中
- **需求描述**：系统应在事件激活期间向所有在线玩家广播事件状态。
- **来源文件**：Replication.lua
- **验收标准**：
  - 事件开始时通知所有玩家
  - 事件结束时通知所有玩家
  - 新加入玩家获得当前事件状态

### 2.2 事件驱动型需求 (Event-driven Requirements)

#### REQ-EVT-004
- **需求编号**：REQ-EVT-004
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当金币冲刺事件激活时，系统应将所有物品的金币产出提升3倍，并将黄金幸运值提升2倍。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 物品金币产出 × 3
  - 黄金幸运值 × 2
  - UI显示事件激活状态
  - 事件结束后恢复正常

#### REQ-EVT-005
- **需求编号**：REQ-EVT-005
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当火爆促销事件激活时，系统应对所有蛋的价格应用50%折扣。
- **来源文件**：Configs/Global Events.lua, Configs/Eggs.lua
- **验收标准**：
  - 所有蛋价格减半
  - 商店UI显示折扣价格
  - 购买时按折扣价扣费
  - 事件结束后恢复原价

#### REQ-EVT-006
- **需求编号**：REQ-EVT-006
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当闪电风暴事件激活时，系统应在地图上随机生成闪电攻击，玩家需要躲避。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 闪电随机出现在地图上
  - 闪电有预警效果
  - 被击中的玩家受到影响
  - 提高Electric变异概率

#### REQ-EVT-007
- **需求编号**：REQ-EVT-007
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当太阳耀斑事件激活时，系统应在地图上创建高温区域，玩家需要避免烧伤。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 地图显示高温区域
  - 玩家在高温区域受到伤害
  - 提高Fire变异概率
  - 视觉效果表现炎热

#### REQ-EVT-008
- **需求编号**：REQ-EVT-008
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当冰冻风暴事件激活时，系统应随机冻结地图上的物品。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 物品可能被冻结
  - 冻结的物品无法收集
  - 提高Ice变异概率
  - 环境显示冰冻效果

#### REQ-EVT-009
- **需求编号**：REQ-EVT-009
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当故障事件激活时，系统应在地图上生成故障点。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 故障点随机分布
  - 故障点有特殊视觉效果
  - 提高Glitch变异概率
  - 可能影响游戏机制

### 2.3 状态驱动型需求 (State-driven Requirements)

#### REQ-EVT-010
- **需求编号**：REQ-EVT-010
- **需求类型**：状态驱动型
- **优先级**：高
- **需求描述**：当事件处于"激活"状态时，系统应在UI上显示事件名称、剩余时间和效果说明。
- **来源文件**：Client/Interface/Main.lua
- **验收标准**：
  - 显示事件名称和图标
  - 实时倒计时显示
  - 简要说明事件效果
  - UI位置不遮挡游戏

#### REQ-EVT-011
- **需求编号**：REQ-EVT-011
- **需求类型**：状态驱动型
- **优先级**：中
- **需求描述**：当多个事件同时激活时，系统应正确处理事件效果的叠加。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 效果可以叠加
  - 不产生冲突
  - UI分别显示各事件
  - 性能保持稳定

### 2.4 可选特性需求 (Optional Feature Requirements)

#### REQ-EVT-012
- **需求编号**：REQ-EVT-012
- **需求类型**：可选特性
- **优先级**：低
- **需求描述**：如果启用了事件预告功能，系统应在事件开始前5分钟通知玩家。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 提前5分钟发送预告
  - 预告包含事件类型
  - 可以关闭预告功能
  - 不影响突发事件

#### REQ-EVT-013
- **需求编号**：REQ-EVT-013
- **需求类型**：可选特性
- **优先级**：低
- **需求描述**：如果玩家拥有事件保护道具，系统应减少负面事件对玩家的影响。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 减少伤害效果
  - 延长保护时间
  - 道具有使用次数
  - UI显示保护状态

### 2.5 复杂型需求 (Complex Requirements)

#### REQ-EVT-014
- **需求编号**：REQ-EVT-014
- **需求类型**：复杂型
- **优先级**：高
- **需求描述**：系统应支持事件调度机制，当满足特定条件时自动触发事件，同时确保事件之间有合理的间隔，避免玩家疲劳。
- **来源文件**：Configs/Global Events.lua
- **验收标准**：
  - 事件按计划表触发
  - 最小间隔时间限制
  - 支持手动触发（管理员）
  - 记录事件历史

#### REQ-EVT-015
- **需求编号**：REQ-EVT-015
- **需求类型**：复杂型
- **优先级**：中
- **需求描述**：当环境类事件（闪电风暴、太阳耀斑、冰冻风暴）同时激活时，系统应创建极端天气效果，同时所有相关变异概率都提升。
- **来源文件**：Configs/Global Events.lua, Configs/Mutations.lua
- **验收标准**：
  - 识别环境事件组合
  - 创建混合视觉效果
  - 变异概率叠加计算
  - 特殊成就解锁

## 3. 非功能需求

### 3.1 性能需求
- 事件切换时间小于2秒
- 事件效果不降低帧率超过10%
- 支持至少100名玩家同时体验事件

### 3.2 可靠性需求
- 事件状态必须全服同步
- 断线重连保持事件状态
- 事件数据防止丢失

### 3.3 安全性需求
- 防止客户端触发事件
- 防止修改事件参数
- 事件效果服务器验证

## 4. 接口需求

### 4.1 模块接口
- 与物品系统接口：应用金币倍率
- 与蛋类系统接口：应用价格折扣
- 与变异系统接口：调整变异概率
- 与UI系统接口：显示事件信息

### 4.2 数据接口
```lua
-- 事件数据结构
GlobalEvent = {
    id = string,
    name = string,
    duration = number,
    effects = {
        coinMultiplier = number,
        luckMultiplier = number,
        priceDiscount = number,
        mutationBoost = table
    },
    active = boolean,
    startTime = number,
    endTime = number
}

-- 事件触发数据
EventTrigger = {
    eventId = string,
    triggerType = string, -- "scheduled", "manual", "random"
    conditions = table,
    timestamp = number
}
```

## 5. 验收测试方案

### 5.1 功能测试
1. 验证6种事件的独立触发
2. 测试事件效果的正确应用
3. 测试事件的开始和结束
4. 测试多事件同时激活
5. 测试事件调度机制

### 5.2 性能测试
1. 测试事件切换的响应时间
2. 测试事件效果对性能影响
3. 测试大量玩家时的同步

### 5.3 兼容性测试
1. 测试不同设备的事件表现
2. 测试与其他系统的协作
3. 测试网络延迟的影响

## 6. 风险和假设

### 6.1 风险
- 频繁事件可能让玩家疲劳
- 事件平衡性影响游戏体验
- 视觉效果可能影响性能

### 6.2 假设
- 服务器能够处理事件负载
- 玩家享受事件带来的变化
- 事件调度算法合理

## 7. 版本历史
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-07-22 | 初始版本 | 系统分析师 |