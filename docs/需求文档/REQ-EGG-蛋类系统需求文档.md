# 蛋类系统需求文档 (EGG)

## 文档信息
- 文档编号：REQ-EGG-v1.0
- 创建日期：2025-07-22
- 作者：系统分析师
- 状态：草案

## 1. 概述

### 1.1 目的
本文档定义了TrueSinging游戏中蛋类系统的功能需求，包括蛋的购买、孵化、掉落机制和幸运值系统等功能。

### 1.2 范围
蛋类系统涵盖游戏中所有蛋的管理，包括：
- 8种不同等级的蛋
- 蛋的生成和传送带机制
- 孵化机制
- 价格体系和幸运倍数系统
- 错过的蛋收集和购买功能

### 1.3 相关文档
- 代码结构整合文档.md
- src/ReplicatedStorage/Library/Configs/Eggs.lua
- src/ReplicatedStorage/Library/Configs/Islands.lua
- src/ReplicatedStorage/Library/Roll.lua
- src/StarterPlayer/StarterPlayerScripts/Client/Controllers/Conveyors.lua
- src/StarterPlayer/StarterPlayerScripts/Client/Controllers/Missed Eggs.lua
- src/StarterPlayer/StarterPlayerScripts/Client/Interface/Tabs/Missed Eggs.lua
- src/StarterPlayer/StarterPlayerScripts/Client/Interface/Main.lua

## 2. 功能需求

### 2.1 蛋的生成和传送机制

#### REQ-EGG-GEN-001
- **需求编号**：REQ-EGG-GEN-001
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应在传送带上根据配置的权重自动生成蛋，高权重的蛋出现概率更高。
- **来源文件**：Configs/Islands.lua, Roll.lua
- **验收标准**：
  - Egg1（基础蛋）权重500，出现频率最高
  - Egg8（尖刺蛋）权重0.5，出现频率最低
  - 生成算法使用加权随机选择
  - 支持幸运值调整稀有蛋出现概率

#### REQ-EGG-GEN-002
- **需求编号**：REQ-EGG-GEN-002
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：生成的蛋应在传送带上从起点移动到终点，玩家可以在移动过程中购买。
- **来源文件**：Controllers/Conveyors.lua
- **验收标准**：
  - 正常模式：15秒完成移动
  - 快速模式：7.5秒完成移动
  - 教程模式：30秒完成移动
  - 移动末期（最后1秒）禁用购买

#### REQ-EGG-GEN-003
- **需求编号**：REQ-EGG-GEN-003
- **需求类型**：状态驱动型
- **优先级**：高
- **需求描述**：系统应实现"错过的蛋"收集机制，未被购买的蛋将被临时存储。
- **来源文件**：Controllers/Missed Eggs.lua, Interface/Tabs/Missed Eggs.lua
- **验收标准**：
  - 未购买的蛋自动进入Reserve（保留区）
  - 每个错过的蛋保留25秒
  - 显示剩余时间倒计时
  - 时间少于10秒时显示红色警告

#### REQ-EGG-GEN-004
- **需求编号**：REQ-EGG-GEN-004
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：玩家应能够通过"错过的蛋"界面购买之前错过的蛋。
- **来源文件**：Interface/Tabs/Missed Eggs.lua
- **验收标准**：
  - 点击错过的蛋触发购买流程
  - 服务器验证蛋是否仍然有效
  - 过期的蛋显示"That egg has disappeared :("
  - 成功购买后从错过列表移除

### 2.2 泛在型需求 (Ubiquitous Requirements)

#### REQ-EGG-001
- **需求编号**：REQ-EGG-001
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应提供8种不同等级的蛋（Egg1到Egg8），每种蛋具有唯一的标识符、价格、孵化时间和幸运倍数。
- **来源文件**：Configs/Eggs.lua
- **验收标准**：
  - 系统中存在8种不同的蛋定义
  - 每种蛋具有唯一的ID（Egg1-Egg8）
  - 价格范围从100到100,000,000
  - 孵化时间从5秒到3600秒

#### REQ-EGG-002
- **需求编号**：REQ-EGG-002
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应为每种蛋设置递增的价格体系，高等级蛋的价格显著高于低等级蛋。
- **来源文件**：Configs/Eggs.lua
- **验收标准**：
  - Egg1价格：100
  - Egg2价格：1,000
  - Egg3价格：10,000
  - Egg4价格：100,000
  - Egg5价格：1,000,000
  - Egg6价格：10,000,000
  - Egg7价格：50,000,000
  - Egg8价格：100,000,000

#### REQ-EGG-003
- **需求编号**：REQ-EGG-003
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应为每种蛋设置幸运倍数，范围从1倍到25,000倍。
- **来源文件**：Configs/Eggs.lua
- **验收标准**：
  - 低等级蛋幸运倍数较低（1x-10x）
  - 高等级蛋幸运倍数较高（最高25,000x）
  - 幸运倍数影响物品掉落概率

### 2.2 事件驱动型需求 (Event-driven Requirements)

#### REQ-EGG-004
- **需求编号**：REQ-EGG-004
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当玩家购买蛋时，系统应扣除相应的金币并将蛋添加到玩家的库存中。
- **来源文件**：Configs/Eggs.lua, Replication.lua
- **验收标准**：
  - 检查玩家金币是否足够
  - 扣除正确的金币数量
  - 蛋成功添加到玩家库存
  - 购买失败时返回错误提示

#### REQ-EGG-005
- **需求编号**：REQ-EGG-005
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当玩家开始孵化蛋时，系统应启动孵化计时器并在指定时间后完成孵化。
- **来源文件**：Configs/Eggs.lua, Client/Interface/Main.lua
- **验收标准**：
  - 孵化计时器准确计时
  - 孵化进度实时显示
  - 孵化时间与配置一致
  - 孵化完成触发奖励发放

#### REQ-EGG-006
- **需求编号**：REQ-EGG-006
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当火爆促销事件激活时，系统应对所有蛋应用50%折扣。
- **来源文件**：Configs/Global Events.lua, Configs/Eggs.lua
- **验收标准**：
  - 事件期间所有蛋价格减半
  - UI显示折扣后价格
  - 购买时按折扣价格扣费
  - 事件结束后恢复原价

#### REQ-EGG-007
- **需求编号**：REQ-EGG-007
- **需求类型**：事件驱动型
- **优先级**：中
- **需求描述**：当启用自动孵化功能时，系统应自动开始孵化玩家库存中的下一个蛋。
- **来源文件**：Client/Interface/Main.lua
- **验收标准**：
  - 自动孵化可以开启/关闭
  - 完成一个蛋后自动开始下一个
  - 按照库存顺序孵化
  - 库存为空时停止

### 2.3 状态驱动型需求 (State-driven Requirements)

#### REQ-EGG-008
- **需求编号**：REQ-EGG-008
- **需求类型**：状态驱动型
- **优先级**：高
- **需求描述**：当蛋处于"孵化中"状态时，系统应显示孵化进度条和剩余时间。
- **来源文件**：Client/Interface/Main.lua
- **验收标准**：
  - 进度条实时更新
  - 显示剩余时间（格式：MM:SS）
  - 孵化动画播放
  - 无法取消孵化过程

#### REQ-EGG-009
- **需求编号**：REQ-EGG-009
- **需求类型**：状态驱动型
- **优先级**：中
- **需求描述**：当蛋处于"未购买"状态时，系统应在商店中显示该蛋的购买选项。
- **来源文件**：Client/Interface/Main.lua
- **验收标准**：
  - 显示蛋的图标和名称
  - 显示价格信息
  - 金币不足时禁用购买按钮
  - 显示幸运倍数信息

### 2.4 可选特性需求 (Optional Feature Requirements)

#### REQ-EGG-010
- **需求编号**：REQ-EGG-010
- **需求类型**：可选特性
- **优先级**：低
- **需求描述**：如果玩家拥有孵化加速道具，系统应减少蛋的孵化时间。
- **来源文件**：Configs/Eggs.lua
- **验收标准**：
  - 加速道具正确应用
  - 孵化时间按比例减少
  - UI显示加速效果
  - 道具使用后消耗

#### REQ-EGG-011
- **需求编号**：REQ-EGG-011
- **需求类型**：可选特性
- **优先级**：低
- **需求描述**：如果玩家达到特定成就，系统应解锁特殊蛋类。
- **来源文件**：Library/Badges.lua, Configs/Eggs.lua
- **验收标准**：
  - 成就系统正确追踪
  - 达成条件后解锁新蛋
  - 商店显示解锁的蛋
  - 保存解锁状态

### 2.5 复杂型需求 (Complex Requirements)

#### REQ-EGG-012
- **需求编号**：REQ-EGG-012
- **需求类型**：复杂型
- **优先级**：高
- **需求描述**：当玩家孵化蛋时，系统应根据蛋的幸运倍数和玩家的黄金幸运值计算最终掉落物品，同时当金币冲刺事件激活时，系统应将黄金幸运值提升2倍。
- **来源文件**：Configs/Eggs.lua, Configs/Global Events.lua
- **验收标准**：
  - 基础掉落率 = 蛋幸运倍数
  - 事件期间：最终掉落率 = 蛋幸运倍数 × 2
  - 根据最终掉落率决定物品稀有度
  - 掉落结果显示所有应用的加成

#### REQ-EGG-013
- **需求编号**：REQ-EGG-013
- **需求类型**：复杂型
- **优先级**：中
- **需求描述**：系统应支持批量购买蛋功能，当玩家选择批量购买时，系统应检查金币是否足够购买指定数量，同时当火爆促销事件激活时，系统应对批量购买应用相同的折扣。
- **来源文件**：Configs/Eggs.lua, Client/Interface/Main.lua
- **验收标准**：
  - 支持选择购买数量（1-99）
  - 计算总价 = 单价 × 数量 × 折扣
  - 一次性扣除所有金币
  - 批量添加到库存

## 3. 非功能需求

### 3.1 性能需求
- 孵化计时器精度应达到0.1秒
- 支持同时孵化多个蛋（多账户）
- 蛋的购买响应时间小于200ms

### 3.2 可靠性需求
- 断线重连后孵化进度应保持
- 购买交易必须是原子操作
- 防止重复购买和重复孵化

### 3.3 安全性需求
- 所有购买请求必须服务器验证
- 防止修改客户端跳过孵化时间
- 防止修改幸运倍数获得更好物品

## 4. 接口需求

### 4.1 模块接口
- 与物品系统接口：发放孵化奖励
- 与事件系统接口：获取当前折扣
- 与UI系统接口：更新孵化进度
- 与音效系统接口：播放孵化音效

### 4.2 数据接口
```lua
-- 蛋数据结构
Egg = {
    id = string,
    price = number,
    hatchTime = number,
    luckMultiplier = number,
    icon = string,
    model = Instance
}

-- 孵化事件数据
HatchEvent = {
    eggId = string,
    playerId = number,
    startTime = number,
    endTime = number,
    reward = table
}

-- 传送带蛋配置
ConveyorEgg = {
    Name = string,      -- 蛋的名称
    Weight = number     -- 生成权重
}

-- 错过的蛋数据
MissedEgg = {
    eggName = string,
    mutation = string,
    reserveTime = number,  -- 保留时间戳
    remainingTime = number -- 剩余时间（秒）
}
```

## 5. 验收测试方案

### 5.1 功能测试
1. 验证8种蛋的正确配置
2. 测试蛋的购买流程
3. 测试孵化计时功能
4. 测试自动孵化功能
5. 测试事件折扣应用
6. 测试传送带蛋生成算法
7. 测试蛋在传送带上的移动
8. 测试错过的蛋收集机制
9. 测试错过的蛋购买功能
10. 测试错过的蛋过期机制

### 5.2 性能测试
1. 测试大量玩家同时购买
2. 测试孵化计时器准确性
3. 测试批量购买性能

### 5.3 兼容性测试
1. 测试不同设备上的孵化显示
2. 测试网络延迟下的购买功能
3. 测试与其他系统的交互

## 6. 风险和假设

### 6.1 风险
- 高等级蛋价格可能导致游戏平衡问题
- 孵化时间过长可能影响玩家体验
- 幸运系统可能被恶意利用

### 6.2 假设
- 玩家理解幸运倍数机制
- 服务器能够处理并发孵化请求
- 游戏经济系统保持平衡

## 7. 版本历史
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-07-22 | 初始版本 | 系统分析师 |
| 1.1 | 2025-07-23 | 新增蛋的生成和传送机制需求（REQ-EGG-GEN-001至004） | 系统分析师 |