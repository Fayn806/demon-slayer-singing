# 变异系统需求文档 (MUT)

## 文档信息
- 文档编号：REQ-MUT-v1.0
- 创建日期：2025-07-22
- 作者：系统分析师
- 状态：草案

## 1. 概述

### 1.1 目的
本文档定义了TrueSinging游戏中变异系统的功能需求，包括7种变异类型、倍率机制、视觉效果和与其他系统的交互。

### 1.2 范围
变异系统涵盖游戏中所有物品的变异机制，包括普通、黄金、钻石、电力、火焰、冰冻和故障等变异类型。

### 1.3 相关文档
- 代码结构整合文档.md
- src/ReplicatedStorage/Library/Configs/Mutations.lua
- src/ReplicatedStorage/Library/Configs/Items.lua
- src/ReplicatedStorage/Library/Configs/Global Events.lua

## 2. 功能需求

### 2.1 泛在型需求 (Ubiquitous Requirements)

#### REQ-MUT-001
- **需求编号**：REQ-MUT-001
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应提供7种变异类型：Normal(普通)、Golden(黄金)、Diamond(钻石)、Electric(电力)、Fire(火焰)、Ice(冰冻)、Glitch(故障)。
- **来源文件**：Configs/Mutations.lua
- **验收标准**：
  - 系统中存在7种变异类型定义
  - 每种变异具有唯一标识符
  - 每种变异具有对应的倍率值

#### REQ-MUT-002
- **需求编号**：REQ-MUT-002
- **需求类型**：泛在型
- **优先级**：高
- **需求描述**：系统应为每种变异类型设置金币产出倍率，范围从1倍到10倍。
- **来源文件**：Configs/Mutations.lua
- **验收标准**：
  - Normal: 1x倍率
  - Golden: 2x倍率
  - Diamond: 3x倍率
  - Electric: 5x倍率
  - Fire: 10x倍率
  - Ice: 10x倍率
  - Glitch: 10x倍率

#### REQ-MUT-003
- **需求编号**：REQ-MUT-003
- **需求类型**：泛在型
- **优先级**：中
- **需求描述**：系统应为每种变异类型提供独特的视觉效果。
- **来源文件**：Configs/Mutations.lua
- **验收标准**：
  - 黄金变异显示金色效果
  - 钻石变异显示闪亮效果
  - 电力变异显示电流效果
  - 火焰变异显示燃烧效果
  - 冰冻变异显示冰霜效果
  - 故障变异显示数字故障效果

### 2.2 事件驱动型需求 (Event-driven Requirements)

#### REQ-MUT-004
- **需求编号**：REQ-MUT-004
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当物品生成时，系统应根据概率为物品分配变异类型。
- **来源文件**：Configs/Mutations.lua, Replication.lua
- **验收标准**：
  - 物品生成时触发变异判定
  - 根据预设概率分配变异类型
  - 默认为Normal变异
  - 变异类型保存在物品数据中

#### REQ-MUT-005
- **需求编号**：REQ-MUT-005
- **需求类型**：事件驱动型
- **优先级**：高
- **需求描述**：当玩家收集带有变异的物品时，系统应应用相应的倍率到金币产出。
- **来源文件**：Configs/Mutations.lua, Configs/Items.lua
- **验收标准**：
  - 计算公式：最终金币 = 基础金币 × 变异倍率
  - 变异倍率正确应用
  - UI显示变异加成
  - 金币立即更新

#### REQ-MUT-006
- **需求编号**：REQ-MUT-006
- **需求类型**：事件驱动型
- **优先级**：中
- **需求描述**：当闪电风暴事件激活时，系统应提高Electric变异的出现概率。
- **来源文件**：Configs/Global Events.lua, Configs/Mutations.lua
- **验收标准**：
  - 事件期间Electric变异概率提升
  - 其他变异概率相应调整
  - 事件结束后恢复正常概率

#### REQ-MUT-007
- **需求编号**：REQ-MUT-007
- **需求类型**：事件驱动型
- **优先级**：中
- **需求描述**：当太阳耀斑事件激活时，系统应提高Fire变异的出现概率。
- **来源文件**：Configs/Global Events.lua, Configs/Mutations.lua
- **验收标准**：
  - 事件期间Fire变异概率提升
  - 物品可能显示燃烧效果
  - 事件结束后恢复正常

#### REQ-MUT-008
- **需求编号**：REQ-MUT-008
- **需求类型**：事件驱动型
- **优先级**：中
- **需求描述**：当冰冻风暴事件激活时，系统应提高Ice变异的出现概率。
- **来源文件**：Configs/Global Events.lua, Configs/Mutations.lua
- **验收标准**：
  - 事件期间Ice变异概率提升
  - 物品可能被冻结
  - 事件结束后恢复正常

### 2.3 状态驱动型需求 (State-driven Requirements)

#### REQ-MUT-009
- **需求编号**：REQ-MUT-009
- **需求类型**：状态驱动型
- **优先级**：高
- **需求描述**：当物品处于变异状态时，系统应持续显示对应的视觉效果。
- **来源文件**：Configs/Mutations.lua
- **验收标准**：
  - 变异效果持续显示
  - 效果强度与变异等级匹配
  - 不影响物品的可交互性

#### REQ-MUT-010
- **需求编号**：REQ-MUT-010
- **需求类型**：状态驱动型
- **优先级**：中
- **需求描述**：当物品处于Ice变异且冰冻风暴激活时，系统应暂时禁止收集该物品。
- **来源文件**：Configs/Mutations.lua, Configs/Global Events.lua
- **验收标准**：
  - 双重条件判断
  - 物品显示冻结状态
  - 无法收集但可查看
  - 解冻后恢复正常

### 2.4 可选特性需求 (Optional Feature Requirements)

#### REQ-MUT-011
- **需求编号**：REQ-MUT-011
- **需求类型**：可选特性
- **优先级**：低
- **需求描述**：如果玩家拥有变异识别能力，系统应在物品上方显示变异类型标识。
- **来源文件**：Configs/Mutations.lua
- **验收标准**：
  - 显示变异类型名称
  - 显示倍率信息
  - 标识清晰可见
  - 可以开关此功能

#### REQ-MUT-012
- **需求编号**：REQ-MUT-012
- **需求类型**：可选特性
- **优先级**：低
- **需求描述**：如果启用了变异统计，系统应记录玩家收集的各种变异物品数量。
- **来源文件**：Configs/Mutations.lua
- **验收标准**：
  - 分类统计各变异数量
  - 显示变异收集率
  - 支持查看历史记录
  - 数据持久保存

### 2.5 复杂型需求 (Complex Requirements)

#### REQ-MUT-013
- **需求编号**：REQ-MUT-013
- **需求类型**：复杂型
- **优先级**：高
- **需求描述**：当多个变异加成同时生效时（如Golden变异物品在金币冲刺事件期间被收集），系统应正确计算所有倍率的叠加效果。
- **来源文件**：Configs/Mutations.lua, Configs/Global Events.lua
- **验收标准**：
  - 基础计算：物品基础金币 × 变异倍率
  - 事件加成：上述结果 × 事件倍率
  - 最终金币正确计算
  - UI显示所有应用的加成

#### REQ-MUT-014
- **需求编号**：REQ-MUT-014
- **需求类型**：复杂型
- **优先级**：中
- **需求描述**：当故障事件激活时，系统应在地图上生成故障点，同时提高Glitch变异的出现率，并且靠近故障点的物品有更高概率获得Glitch变异。
- **来源文件**：Configs/Global Events.lua, Configs/Mutations.lua
- **验收标准**：
  - 故障点随机生成
  - 距离越近概率越高
  - Glitch变异整体概率提升
  - 故障点有视觉提示

## 3. 非功能需求

### 3.1 性能需求
- 变异判定时间应小于50ms
- 视觉效果不应降低帧率超过5%
- 支持同时显示100个带变异效果的物品

### 3.2 可靠性需求
- 变异类型分配必须公平随机
- 倍率计算必须精确
- 变异数据必须持久保存

### 3.3 安全性需求
- 防止客户端修改变异类型
- 防止修改变异倍率
- 所有变异判定在服务器进行

## 4. 接口需求

### 4.1 模块接口
- 与物品系统接口：应用变异到物品
- 与事件系统接口：获取事件影响
- 与UI系统接口：显示变异效果
- 与音效系统接口：播放变异音效

### 4.2 数据接口
```lua
-- 变异数据结构
Mutation = {
    type = string,
    multiplier = number,
    visualEffect = string,
    probability = number
}

-- 变异物品数据
MutatedItem = {
    itemId = string,
    mutationType = string,
    baseCoins = number,
    finalCoins = number
}
```

## 5. 验收测试方案

### 5.1 功能测试
1. 验证7种变异类型配置
2. 测试变异概率分配
3. 测试倍率计算准确性
4. 测试事件期间的概率变化

### 5.2 性能测试
1. 测试大量变异物品的渲染性能
2. 测试变异判定的响应时间
3. 测试特效对性能的影响

### 5.3 兼容性测试
1. 测试不同设备上的效果显示
2. 测试与其他系统的协同工作
3. 测试网络延迟下的变异同步

## 6. 风险和假设

### 6.1 风险
- 高倍率变异可能破坏游戏平衡
- 视觉效果可能影响低端设备
- 概率系统可能被玩家质疑

### 6.2 假设
- 随机数生成器足够随机
- 玩家理解变异机制
- 视觉效果不会造成视觉疲劳

## 7. 版本历史
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-07-22 | 初始版本 | 系统分析师 |